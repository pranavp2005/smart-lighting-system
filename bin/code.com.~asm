.MODEL TINY


.DATA
PORTA equ 0000h
PORTB equ 0002h
PORTC equ 0004h
CWREG equ 0006h


.CODE
.STARTUP


init:   ORG 0000h

; This register will serve as internal memory and store the number of people in the room.
mov dl, 00h

; Set up the PPI to read from Port A and write to Port B and Port C.
mov al, 10010000b
OUT CWREG, al


main:   ;CALL check_entry
;CALL check_exit
CALL open_door
CALL delay
CALL delay
CALL close_door
CALL delay
CALL delay
JMP main


delay PROC NEAR
; A small timed delay. The caller should set CX before calling.
p1:     NOP
DEC cx
JNE p1
ret
delay ENDP


delay_db PROC NEAR
; A debounce delay mechanism implemented on Port A's pressure sensors (push buttons).
p2:     IN al, PORTA
CMP al, 0h
JNE p2
ret
delay_db ENDP


incr_cnt PROC NEAR
; Increase the count value and update the display.
INC dl;
MOV al, dl
OUT PORTC, al
ret
incr_cnt ENDP


decr_cnt PROC NEAR
; Decrease the count value and update the display.
DEC dl;
MOV al, dl
OUT PORTC, al
ret
decr_cnt ENDP


open_door PROC NEAR
MOV al, 00000001b
OUT PORTB, al
ret
open_door ENDP


close_door PROC NEAR
MOV al, 00000010b
OUT PORTB, al
ret
close_door ENDP


check_entry PROC NEAR
; Check to see if the external pressure sensor has been triggered.
IN   al, PORTA
CMP  al, 00000001b
JNE  p5

; Open the door once the external pressure sensor has been triggered.
CALL open_door

; Check to see if the internal pressure sensor has been triggered. Provide a small window of time for entry.
MOV  cx, 0FFFFh
p3:     IN   al, PORTA
CMP  al, 00000010b
JE   p4
DEC  cx
JNE  p3
JMP  p5

; Increase the count if both have been triggered. Then close the door.
p4:     CALL incr_cnt
CALL close_door

p5:     ret
check_entry ENDP


check_exit PROC NEAR
; Check to see if the internal pressure sensor has been triggered.
IN   al, PORTA
CMP  al, 00000010b
JNE  p8

; Open the door once the internal pressure sensor has been triggered.
CALL open_door

; Check to see if the external pressure sensor has been triggered. Provide a small window of time for entry.
MOV  cx, 0FFFFh
p6:     IN   al, PORTA
CMP  al, 00000001b
JE   p7
DEC  cx
JNE  p6
JMP  p8

; Increase the count if both have been triggered.
p7:     CALL decr_cnt
CALL close_door

p8:     ret
check_exit ENDP

END


; POSSIBLE OPTIMIZTIONS:
; 1. Use a flag/moniter/semaphore to prevent entry/exit race conditions.



; [SOURCE]: D:\Data\Acads\MuP\Smart Lighting System Attempt\src\code.asm
